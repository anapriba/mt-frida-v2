Bootstrap: docker
From: condaforge/mambaforge:latest

%files
  conda.yml

%environment
  export TZ=Etc/UTC

%post

  apt-get -y update; apt-get -y upgrade;
  conda env update -n base --file /conda.yml;
  pip install --upgrade pip;
  pip install nltk; 
  python -m nltk.downloader punkt;


%runscript
  echo conda --version
  pattern=$( echo ${CUDA_VISIBLE_DEVICES} | tr ',' '|' )
  export CUDA_VISIBLE_DEVICES=$( nvidia-smi -L | egrep "${pattern}" | egrep -o "GPU [0-3]" | egrep -o "[0-3]" | tr "\n" "," )
  python $@
